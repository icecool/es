<?php
namespace APP\MVC\V;
/*
 * те которые имеют фото
Мактаби № 70
Мактаби № 47
Мактаб-интернати № 3
Маркази рушди истеъдодхо
Кўдакистони № 22
*/
class MAP_V {

    public function main($model, $show_bar=true){
    	$result='';
    	$muassisaho=$model->get_muassisaho();
    	$mks='';
    	$fg=false;
    	foreach ($muassisaho as $key => $v) {
    		if($v['geo_lat']!=''){
    			if($fg) $mks.=",\n";
    			$mks.='[ '.$v['geo_lng'].','.$v['geo_lat'].', "'.$v['name_ru'].'", "'.$v['director'].'", "'.$v['address'].'", "'.$v['phone'].'", "'.$v['namud'].'", "'.$v['muassisa_photo'].'"]';
    			if(!$fg){$fg=true;}
    		}    		
    	}
    	$mlist='';
    	if(count($muassisaho)>0){
    		$mlist.='<select id="xlist">'."\n";
    			foreach($muassisaho as $k=>$vl){
    				$gc='';
    				if($vl['geo_lat']!='') $gc=' *';
    				$mlist.='<option value="'.$k.'">'.$vl['name_ru'].' ('.$vl['geo-name'].') '.$gc.'</option>'."\n"; 
    			}
    		$mlist.="</select>\n";    		
    	}
    	\CORE\BC\UI::init()->pos['link'].='<link rel="stylesheet" href="'.UIPATH.'/ext/map/leaflet.css" />';
        \CORE\BC\UI::init()->pos['js'].="<script src='ui/js/muassisaho.js'></script>";
    	\CORE\BC\UI::init()->pos['js'].='
    	<script src="'.UIPATH.'/ext/map/leaflet.js"></script>
    	<script src="'.UIPATH.'/ext/map/singleclick.js"></script>
		<script language="javascript">
            var map;
            var all_markers = new Array();
			function SaveCoords(xlat, xlng){
				var xid = $("#xlist").val();
				$.post("./?c=map&act=ajax&do=marker",{ id: xid, lat: xlat, lng: xlng }, function(data){
					if(data=="ok") {
						//alert("Точка добавлена!");
					} else {
						alert(data);
					}
				});
			}

	        function init() {

	            map = new L.Map(\'map\');

	            L.tileLayer(\'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png\', {
	                attribution: \'&copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors\',
	                maxZoom: 17
	            }).addTo(map);

	            map.attributionControl.setPrefix(\'\'); // Dont show the Powered by Leaflet text.

	            ';

                if ($show_bar) {
                    $re='map.setView(new L.LatLng(38.5495108,68.7781477), 12);';
                }else{
                    $re='map.setView(new L.LatLng(38.58427060213333,68.76437187194824), 13);';
                }

                \CORE\BC\UI::init()->pos['js'].=$re.'
                //map.setView(new L.LatLng(38.5495108,68.7781477), 12);
	            // Define an array. This could be done in a seperate js file.
	            // This tidy formatted section could even be generated by a server-side script
	            // or fetched seperately as a jsonp request.

	            var markers = [
	                '.$mks.'
	            ];
                //console.log("log: "+markers);

                var greenIcon = L.icon({
                    iconUrl: "ui/ext/map/images/green.png",
                    shadowUrl: "ui/ext/map/images/marker-shadow.png",
                    iconSize:     [41, 41], // size of the icon
                    shadowSize:   [41, 41], // size of the shadow
                    iconAnchor:   [22, 40], // point of the icon which will correspond to marker\'s location
                    shadowAnchor: [10, 40],  // the same for the shadow
                    popupAnchor:  [-2, -35] // point from which the popup should open relative to the iconAnchor
                });
                var blueIcon = L.icon({
                    iconUrl: "ui/ext/map/images/azure.png",
                    shadowUrl: "ui/ext/map/images/marker-shadow.png",
                    iconSize:     [41, 41], // size of the icon
                    shadowSize:   [41, 41], // size of the shadow
                    iconAnchor:   [22, 40], // point of the icon which will correspond to marker\'s location
                    shadowAnchor: [10, 40],  // the same for the shadow
                    popupAnchor:  [-2, -35] // point from which the popup should open relative to the iconAnchor
                });
                var pinkIcon = L.icon({
                    iconUrl: "ui/ext/map/images/pink.png",
                    shadowUrl: "ui/ext/map/images/marker-shadow.png",
                    iconSize:     [41, 41], // size of the icon
                    shadowSize:   [41, 41], // size of the shadow
                    iconAnchor:   [22, 40], // point of the icon which will correspond to marker\'s location
                    shadowAnchor: [10, 40],  // the same for the shadow
                    popupAnchor:  [-2, -35] // point from which the popup should open relative to the iconAnchor
                });
                var yellowIcon = L.icon({
                    iconUrl: "ui/ext/map/images/yellow.png",
                    shadowUrl: "ui/ext/map/images/marker-shadow.png",
                    iconSize:     [41, 41], // size of the icon
                    shadowSize:   [41, 41], // size of the shadow
                    iconAnchor:   [22, 40], // point of the icon which will correspond to marker\'s location
                    shadowAnchor: [10, 40],  // the same for the shadow
                    popupAnchor:  [-2, -35] // point from which the popup should open relative to the iconAnchor
                });
	            //Loop through the markers array
	            for (var i=0; i<markers.length; i++) {
	            //for (var i=0; i<2; i++) {

	                var lon = markers[i][0];
	                var lat = markers[i][1];
	                var photo = \'ui/img/no-image.64.png\';
	                if (markers[i][7].length>0){
	                    photo = \'ui/img/muassisaho_photos/\'+markers[i][7];
	                }
	                var popupText = \'<p><img style="padding-right: 5px;" src="\'+photo+\'" align="left" /> \\
	                <strong>\'+markers[i][2]+\'</strong> \\
	                <br/><strong>Директор: </strong>\'+markers[i][3]+\' \\
	                <br/><strong>Адрес: </strong>\'+markers[i][4]+\' \\
	                <br/><strong>Телефон: </strong>\'+markers[i][5]+\' \\
	                <br/><strong class="pull-right"><a href="\'+markers[i][5]+\'">Подробнее</a></p> \';

	                var markerLocation = new L.LatLng(lat, lon);

	                if (markers[i][6]==1)
	                    var marker = new L.Marker(markerLocation, {icon: greenIcon});
                    else if (markers[i][6]==2)
                        var marker = new L.Marker(markerLocation, {icon: blueIcon});
                    else if (markers[i][6]==3)
                        var marker = new L.Marker(markerLocation, {icon: pinkIcon});
                    else
                        var marker = new L.Marker(markerLocation, {icon: yellowIcon});

	                map.addLayer(marker);
                    all_markers.push(marker);
	                marker.bindPopup(popupText,{
	                    minWidth: 230
	                });


	            }

	            // addMarkerByClick

	            var zmarker = null;

	            map.on("singleclick",function ( e ) {
	                    console.log(e.latlng.lat + \' : \' + e.latlng.lng);
		                if ($("#xflag").is(":checked")) {
		                		if(zmarker!=null) map.removeLayer(zmarker);
		                    var markerLocation = new L.LatLng(e.latlng.lat, e.latlng.lng);
		                    var xmarker = new L.Marker(markerLocation);
		                    	zmarker = xmarker;
		                    map.addLayer(xmarker);
		                    //console.log( "singleclick", e );
		                    //L.popup().setLatLng( e.latlng )
		                    //    .setContent( "<p><code>singleclick</code> at " + e.latlng )
		                    //    .openOn( map );
		                    alert(e.latlng.lat + \' : \' + e.latlng.lng);
		                    //SaveCoords(e.latlng.lat, e.latlng.lng);
		                }
		            } );
		        
	        }

	        $(document).ready(function() {

	        	init();
                $("#xlist").change(function(){
                    var muassisa_id = $(this).val();

                    $.post("./?c=map&act=getcoords",{ muassisa_id: muassisa_id}, function(data){
                        var data = jQuery.parseJSON(data);
                        if (data.lat>0 && data.lng>0){
                            jump(data.lng, data.lat);
                        }else{
                            console.log(\'xoli\');
                        }
                    });
                });
			});
			function jump(lon,lat) {
                console.log("jumping ...lon"+lon+", lat="+lat);
			   map.setView(new L.LatLng(lat, lon),18);
			   for(i=0;i<all_markers.length;i++) {
                    if (all_markers[i]._latlng.lat==lat && all_markers[i]._latlng.lng==lon){
                        all_markers[i].openPopup();
                    }
			   }
               var stuSplit = L.latLng(lat, lon);
               var myMarker = L.circleMarker(stuSplit, { title: \'unselected\' }).addTo(map);

            }
	    </script>
    	';
    	$result.='
        <div class="row">';
                if ($show_bar) {
                    $result.='<div class="col-sm-10"><div id="map" style="height: 540px"></div>';
                }else{
                    $result.='<div class="col-sm-12">
                    <div id="map" class="mapx" style="height: 340px"></div>';
                }
                /*<div id="mysidebar">
                    <div id="xsidebar" class="xmg">'.$mlist.' <input type="checkbox" id="xflag">
                    <label for="xflag">edit</label>
                    </div>
                </div>*/
            $result.='</div>';
            if ($show_bar) {
                $result .= '<div class="col-sm-2">
                <h4>Поиск по школам</h4>
                <div style="height:540px; overflow: auto; max-height: 490px;">
                <p>Фильтр по учереждениям</p>
                <select id="namudi_muassisa" class="form-control">';
                $namudho = $model->get_namudi_muassisa();
                foreach ($namudho as $key => $v) {
                    if ($key == 2) {
                        $result .= '<option selected value=' . $key . '>' . $v . '</option>';
                    } else {
                        $result .= '<option value=' . $key . '>' . $v . '</option>';
                    }
                }
                $result .= '</select>
                <p>Учереждения</p>
                <ul class="list-group" id="muassisa_list">';
                $muassisaho = $model->get_muassisaho_by_type(2);
                foreach ($muassisaho as $key => $v) {
                    $result .= '<li class="list-group-item"><a class="jump_to_location" data="' . $v['geo_lat'] . '~' . $v['geo_lng'] . '" href="#">' . $v['name_ru'] . '</a></li>';
                }
                $result.='</ul></div></div>';
            }
        $result.='</div>';
		return $result;
    }

}